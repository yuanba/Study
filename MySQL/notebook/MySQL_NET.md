### MySQL - C语言中文网资源笔记

#### MySQL基础

1. 存储引擎

   | 特点      | Myisam | BDB  | Memory | InnoDB | Archive |
   | ------- | ------ | ---- | ------ | ------ | ------- |
   | 存储限制    | 没有     | 没有   | 有      | 64TB   | 没有      |
   | 事务安全    |        | 支持   |        | 支持     |         |
   | 锁机制     | 表锁     | 页锁   | 表锁     | 行锁     | 行锁      |
   | B树索引    | 支持     | 支持   | 支持     | 支持     |         |
   | 哈希索引    |        |      | 支持     | 支持     |         |
   | 全文索引    | 支持     |      |        |        |         |
   | 集群索引    |        |      |        | 支持     |         |
   | 数据缓存    |        |      | 支持     | 支持     |         |
   | 索引缓存    | 支持     |      | 支持     | 支持     |         |
   | 数据可压缩   | 支持     |      |        |        | 支持      |
   | 空间使用    | 低      | 低    | N/A    | 高      | 非常低     |
   | 内存使用    | 低      | 低    | 中等     | 高      | 低       |
   | 批量插入的速度 | 高      | 高    | 高      | 低      | 非常高     |
   | 支持外键    |        |      |        | 支持     |         |

   最常使用的2种存储引擎：

   ​	存储位置在`/var/lib/mysql`下，需要root后才可以进入

   - Myisam是Mysql的默认存储引擎。当create创建新表时，未指定新表的存储引擎时，默认使用Myisam。每个MyISAM在磁盘上存储成三个文件。文件名都和表名相同，扩展名分别是**.frm（存储表定义）、.MYD (MYData，存储数据)、.MYI (MYIndex，存储索引)**。数据文件和索引文件可以放置在不同的目录，平均分布io，获得更快的速度。   
   - InnoDB存储引擎提供了具有提交、回滚和崩溃恢复能力的**事务安全**。但是对比Myisam的存储引擎，InnoDB写的**处理效率差一些并且会占用更多的磁盘空间以保留数据和索引**。

2. 选择的基本原则

   1. 根据存储引擎，确定数据类型

   2. 常用的分类

      - MyISAM 数据存储引擎和数据列：MyISAM数据表，**最好使用固定长度(CHAR)的数据列**代替可变长度(VARCHAR)的数据列。
      - MEMORY存储引擎和数据列：MEMORY数据表目前都使用**固定长度的数据行**存储，因此无论使用CHAR或VARCHAR列都没有关系。两者都是作为CHAR类型处理的。
      - InnoDB 存储引擎和数据列：**建议使用 VARCHAR类型**。

   3. `CHAR`  V.S. `VARCHAR`

      1. `CHAR`是固定长度的，无论存储多少数据，占用的存储控件是固定的，`VARCHAR`是不固定的，动态分配的
      2. `CHAR`尾部的空格保留，`VARCHAR`尾部的空格不保留

      ```mysql
      # 测试
      create table table_name(c char(5) , v varchar(5));
      insert into table_name values("ab " , "ab ");
      select CONCAT(c , "+") ,CONCAT(v , "+") from table_name;
      # 结果
      +-----------------+-----------------+
      | CONCAT(v , '+') | CONCAT(c , '+') |
      +-----------------+-----------------+
      | ab +            | ab+             |
      +-----------------+-----------------+
      ```

   4. `text` V.S .`blob`

      字符串存储和二进制存储类型

      1. 清理碎片

         ```mysql
         #如果您已经删除了表的一大部分，或者如果您已经对含有可变长度行的表（含有VARCHAR, BLOB或TEXT列的表）进行了很多更改，则应使用
         #OPTIMIZE TABLE。被删除的记录被保持在链接清单中，后续的INSERT操作会重新使用旧的记录位置。您可以使用OPTIMIZE TABLE来重新
         #利用未使用的空间，并整理数据文件的碎片。

         #在多数的设置中，您根本不需要运行OPTIMIZE TABLE。即使您对可变长度的行进行了大量的更新，您也不需要经常运行，每周一次或每月一次
         #即可，只对特定的表运行。

         #OPTIMIZE TABLE只对MyISAM, BDB和InnoDB表起作用。
         #注意，在OPTIMIZE TABLE运行过程中，MySQL会锁定表。
         optimize table table_name;    #　清理表空间
         ```

      2. 避免不必要的检索大型的`blob` , `text`，尽量使用索引

   5. 浮点数和定点数

      例子

      ```mysql
      create table test(c1 float(10,2) , c2 decimal(10,2));    # 创建10长度精度是2位的浮点数
      insert into test values(131072.321 , 131072.321);
      select * from test;
      #　结果
      +-----------+-----------+
      | c1        | c2        |
      +-----------+-----------+
      | 131072.31 | 131072.32 |
      +-----------+-----------+
      ```

      上述的问题来源是因为浮点数的存储不精确导致的

      * 浮点数存储数据范围更大，但是精度低
      * 对货币和时间等精度敏感的数据使用`decimal`存储
      * 尽量避免使用浮点数比较运算

   6. 字符集

      * 字符集的更改是高代价的处理，尽量在添加数据之前就确定好数据字符集
      * mysql的字符集包括字符集（CHARACTER）和校对规则（COLLATION）两个概念。字符集是用来定义mysql存储字符串的方式，校对规则则是定义了比较字符串的方式
      * 每个字符集至少对应一个校对规则

      ```mysql
      show character set;    # 查看当前的mysql支持的字符集，支持数据库，表和字段的设定字符集操作
      show collation like "utf8%";    # 查看utf8的校对规则
      ```

      * `UNICODE`

        为了实现对多个字符编码的容纳和控制，出现了`UNICODE`编码

      * 选择合适的字符集

        我们建议在能够完全满足应用的前提下，尽量使用小的字符集。因为更小的字符集意味着能够节省空间、减少网络传输字节数，同时由于存储空间的较小间接的提高了系统的性能

      * MySQL字符集

        mysql的字符集和校对规则有4个级别的默认设置：**服务器级、数据库级、表级和字段级**。分别在不同的地方设置，作用也不相同。

        服务器字符集和校对，在mysql服务启动的时候确定。可以在my.cnf[/etc/mysql]中设置：

        ​    [mysqld]

        ​    default-character-set=utf8

        或者在启动选项中指定：

            ```mysql
        mysql -u root -p --default-character-set=utf8
            ```

        或者在编译的时候指定：

        ​    ./configure --with-charset=utf8

        如果没有特别的指定服务器字符集，**默认使用latin1作为服务器字符集**。上面三种设置的方式都只指定了字符集，没有指定校对规则，这样是使用该字符集默认的校对规则，如果要使用该字符集的非默认校对规则，则需要在指定字符集的同时指定校对规则。

        ```mysql
        show variables like "character_set_server";     # 现实当前使用的字符集
        ```

#### 索引和锁

1. 索引概述

   1. MySQL中的所有的列类型都可以被索引，可以提高我们的SELECT的查询效率

2. 索引的设计原则

   1. 并不是要查询的列要被索引而是`WHERE`的过滤列才是主要的考虑点
   2. 唯一索引好处多 : 当我们的索引的独立性越强索引的效果越好(比如分男女的索引效果最差)
   3. 使用短索引 : 只要我们在移动成都上可以很独立的区分开我们的数据，尽量就是用短索引(前缀)
   4. **在创建一个n 列的索引时，实际是创建了MySQL可利用的n 个索引**。多列索引可起几个索引的作用，因为可利用索引中最左边的列集来匹配行。这样的列集称为最左前缀。（这与索引一个列的前缀不同，索引一个列的前缀是利用该的前n 个字符作为索引值。）
   5. 索引并不是越多越好，维护索引的时间和控件开销和存储索引的开销都很大

3. 索引

   当我们使用`SELECT`语句进行检索的时候，实际上我们的内部的`WHERE`中对运算符号都进行一定的索引匹配操作

   索引用于快速找出在某个列中有一特定值的行

   `PRIMARY KEY`和`UNIQUE`会建立索引

4. 事务

   1. START TRANSACTION或BEGIN语句可以开始一项新的事务。
   2. COMMIT和ROLLBACK用来提交或者回滚事务。
   3. CHAIN和RELEASE子句分别用来定义在事务提交或者回滚之后的操作，chain会立即启动一个新事物，并且和刚才的事务具有相同的隔离级别，release则会断开和客户端的连接。
   4. SET AUTOCOMMIT可以修改当前连接的提交方式，如果设置了SET AUTOCOMMIT=0，则设置之后的所有事务都需要通过明确的命令进行提交或者回滚。

#### MySQL安全

##### SQL注入

结构化查询语言(SQL)是一种用来和数据库交互的文本语言。SQL Injection 就是利 用某些数据库的外部接口把用户数据插入到实际的数据库操作语言(SQL)当中，从而达到入侵数据库乃至操作系统的目的。它的产生主要是由于程序对用户输入的数据没有进行**严格的过滤**，**导致非法数据库查询语句的执行**。